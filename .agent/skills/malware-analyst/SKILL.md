---
name: malware-analyst
description: "Expert malware analysis including static and dynamic analysis, reverse engineering, sandbox analysis, and threat intelligence"
---

# Malware Analyst

## Overview

This skill transforms you into a **Malware Analysis Expert**. You will master **Static Analysis**, **Dynamic Analysis**, **Behavioral Analysis**, and **Threat Intelligence** for understanding and combating malicious software.

## When to Use This Skill

- Use when analyzing suspicious files
- Use when investigating malware infections
- Use when creating detection signatures
- Use when reverse engineering threats
- Use when building threat intelligence

---

## Part 1: Analysis Workflow

### 1.1 Standard Process

```
Triage → Static Analysis → Dynamic Analysis → Deep Analysis → Reporting
```

### 1.2 Environment Setup

| Component | Purpose |
|-----------|---------|
| **Isolated VM** | Prevent host infection |
| **Snapshot** | Restore clean state |
| **Fake Network** | Capture C2 communication |
| **Analysis Tools** | Debuggers, disassemblers |

### 1.3 Lab Setup

```
┌─────────────────────────────────────┐
│  Host Machine (Hardened)             │
│  ├── VMware/VirtualBox               │
│  │   ├── Windows 10 Analysis VM      │
│  │   │   └── Tools: x64dbg, Ghidra  │
│  │   ├── REMnux (Linux Analysis)     │
│  │   └── INetSim (Fake Internet)     │
│  └── VPN/Isolated Network            │
└─────────────────────────────────────┘
```

---

## Part 2: Static Analysis

### 2.1 Triage

```bash
# File identification
file malware.exe
strings -n 8 malware.exe

# Hashes
md5sum malware.exe
sha256sum malware.exe

# Check VirusTotal
vt file malware.exe
# Or upload manually

# PE analysis
peframe malware.exe
```

### 2.2 PE Analysis

| Section | Suspicious If |
|---------|---------------|
| **Imports** | VirtualAlloc, CreateRemoteThread |
| **Entropy** | > 7.0 (packed/encrypted) |
| **Sections** | Unusual names, high entropy |
| **Resources** | Embedded PE files |
| **Strings** | C2 domains, IPs, registry keys |

### 2.3 Tools

| Tool | Purpose |
|------|---------|
| **PEStudio** | PE header analysis |
| **Detect It Easy** | Packer detection |
| **FLOSS** | Obfuscated string extraction |
| **Capa** | Capability detection |
| **YARA** | Pattern matching |

### 2.4 Capa Analysis

```bash
# Identify malware capabilities
capa malware.exe

# Output example:
# +------------------------+
# | CAPABILITY             |
# +------------------------+
# | create process         |
# | write file             |
# | encrypt data           |
# | connect to HTTP server |
# +------------------------+
```

---

## Part 3: Dynamic Analysis

### 3.1 Sandbox Analysis

| Sandbox | Features |
|---------|----------|
| **Any.run** | Interactive, public/private |
| **Joe Sandbox** | Detailed reports |
| **Hybrid Analysis** | Free, Falcon integration |
| **Cuckoo** | Self-hosted, customizable |

### 3.2 Manual Dynamic Analysis

```bash
# Windows tools
- Process Monitor (file/registry)
- Process Explorer (process tree)
- Wireshark (network)
- Autoruns (persistence)

# Run and observe:
1. Start monitoring tools
2. Snapshot VM
3. Execute malware
4. Capture behavior
5. Analyze artifacts
```

### 3.3 Key Behaviors to Watch

| Category | Indicators |
|----------|------------|
| **Persistence** | Registry Run keys, scheduled tasks |
| **Network** | DNS queries, HTTP/HTTPS, IRC |
| **File System** | Dropped files, encrypted files |
| **Process** | Injection, child processes |
| **Defense Evasion** | Kill AV, disable logging |

---

## Part 4: Advanced Analysis

### 4.1 Unpacking

```bash
# Dump from memory at OEP
x64dbg → Run to OEP → Scylla dump

# UPX unpacker
upx -d packed.exe

# For custom packers: manual unpacking via debugger
```

### 4.2 API Monitoring

```bash
# API Monitor (Windows)
# Hook APIs and log calls

# x64dbg breakpoints
bp CreateProcessW
bp WriteProcessMemory
bp VirtualAllocEx
```

### 4.3 Network Analysis

```bash
# Capture C2 traffic
# Use INetSim to simulate internet

# Extract C2 domains
strings malware.exe | grep -E '[a-z0-9.-]+\.[a-z]{2,}'

# Decode encoded C2
# XOR, Base64, custom encoding
```

---

## Part 5: YARA Rules

### 5.1 Basic YARA Rule

```yara
rule Emotet_Trojan {
    meta:
        description = "Detects Emotet Trojan"
        author = "Analyst"
        date = "2024-01-15"
    
    strings:
        $api1 = "VirtualAllocEx"
        $api2 = "WriteProcessMemory"
        $str1 = "Content-Type: application/x-www-form-urlencoded"
        $pdb = "emotet" nocase
    
    condition:
        uint16(0) == 0x5A4D and  // PE file
        ($api1 and $api2) and
        ($str1 or $pdb)
}
```

### 5.2 YARA Scanning

```bash
# Scan file
yara rules.yar malware.exe

# Scan directory
yara -r rules.yar /samples/

# With strings output
yara -s rules.yar malware.exe
```

---

## Part 6: Reporting

### 6.1 IOC Report

```markdown
## Malware Analysis Report

**Sample:** invoice.exe
**SHA256:** a1b2c3d4...
**Type:** Trojan Downloader
**Family:** Emotet

### Behavior Summary
- Creates persistence via scheduled task
- Downloads second-stage payload from C2
- Exfiltrates system information

### IOCs

| Type | Indicator |
|------|-----------|
| Domain | evil-c2.example.com |
| IP | 192.168.1.100 |
| Hash | a1b2c3d4... |
| Registry | HKCU\Software\... |
| Mutex | Global\EmtMutex123 |

### MITRE ATT&CK Mapping
- T1059 (Command and Scripting)
- T1071 (Application Layer Protocol)
- T1547 (Boot or Logon Autostart)
```

---

## Part 7: Best Practices Checklist

### ✅ Do This

- ✅ **Isolated Environment**: Never run on production.
- ✅ **Snapshot Before Execution**: Easy recovery.
- ✅ **Document Everything**: Screenshots, logs.

### ❌ Avoid This

- ❌ **Analysis on Host**: Risk of infection.
- ❌ **Internet-Connected VM**: Unless simulated.
- ❌ **Sharing Samples Publicly**: Before report finalized.

---

## Related Skills

- `@forensic-investigator` - Evidence collection
- `@senior-penetration-tester` - Offensive techniques
- `@llm-security-specialist` - AI malware detection
